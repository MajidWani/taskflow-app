<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TaskFlow ‚Äî Focused Task Manager</title>

  <!-- TailwindCSS (Play CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: {
              50:  '#eef2ff',
              100: '#e0e7ff',
              200: '#c7d2fe',
              300: '#a5b4fc',
              400: '#818cf8',
              500: '#6366f1',
              600: '#4f46e5',
              700: '#4338ca',
              800: '#3730a3',
              900: '#312e81',
            },
          },
          boxShadow: {
            soft: '0 10px 30px rgba(2,6,23,.08)',
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --radius: 14px; }
    html, body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji'; }
    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.55));
      backdrop-filter: blur(10px);
    }
    .dark .glass { background: linear-gradient(180deg, rgba(17,24,39,.65), rgba(17,24,39,.55)); }
    .brand-gradient { background: linear-gradient(135deg, #6d28d9 0%, #6366f1 40%, #06b6d4 100%); }
    .btn {
      @apply inline-flex items-center justify-center rounded-xl px-4 py-2 font-medium shadow-soft transition;
    }
    .btn-primary {
      @apply text-white bg-brand-600 hover:bg-brand-700 focus:ring-2 focus:ring-offset-2 focus:ring-brand-500;
    }
    .btn-ghost {
      @apply text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800;
    }
    .chip { @apply inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-medium; }
    .chip-green { @apply border-emerald-300 text-emerald-700 bg-emerald-50; }
    .chip-amber { @apply border-amber-300 text-amber-700 bg-amber-50; }
    .chip-slate { @apply border-slate-300 text-slate-700 bg-slate-50; }
    .dark .chip-green { @apply bg-emerald-900/30 text-emerald-200 border-emerald-700; }
    .dark .chip-amber { @apply bg-amber-900/30 text-amber-200 border-amber-700; }
    .dark .chip-slate { @apply bg-slate-800 text-slate-200 border-slate-700; }
    .input {
      @apply w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800/70 px-3.5 py-2.5 outline-none focus:ring-2 focus:ring-brand-400;
    }
    .card {
      @apply rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/70 shadow-soft;
    }
    .kbd { @apply text-[10px] px-1.5 py-0.5 rounded border border-slate-300 dark:border-slate-600 bg-slate-100 dark:bg-slate-800; }
  </style>
</head>

<body class="min-h-screen bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-slate-100">
  <!-- Global App Wrapper -->
  <div id="app" class="min-h-screen">

    <!-- NAVBAR -->
    <header class="sticky top-0 z-40 border-b border-slate-200/70 dark:border-slate-800/80 bg-white/70 dark:bg-slate-950/70 backdrop-blur">
      <div class="mx-auto w-full max-w-7xl px-4 sm:px-6 lg:px-8 py-3 flex items-center gap-3">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-xl brand-gradient grid place-items-center text-white font-bold">TF</div>
          <div class="text-lg font-semibold">TaskFlow</div>
          <div class="hidden sm:block text-slate-400">‚Äî your personal task hub</div>
        </div>
        <div class="ml-auto flex items-center gap-2">
          <button id="themeToggle" class="btn btn-ghost" title="Toggle dark mode">
            <span class="hidden dark:inline">üåô</span><span class="dark:hidden">‚òÄÔ∏è</span>
          </button>
          <button id="exportBtn" class="btn btn-ghost">Export</button>
          <label for="importFile" class="btn btn-ghost cursor-pointer">Import</label>
          <input id="importFile" type="file" accept=".json,.csv" class="hidden" />
          <div id="userEmail" class="hidden sm:block text-sm text-slate-500"></div>
          <div class="relative">
            <button id="profileBtn" class="btn btn-ghost">Account ‚ñæ</button>
            <div id="profileMenu" class="hidden absolute right-0 mt-2 w-48 card p-2">
              <button id="verifyEmailBtn" class="w-full text-left px-3 py-2 rounded hover:bg-slate-100 dark:hover:bg-slate-800">Resend verification</button>
              <button id="signOutBtn" class="w-full text-left px-3 py-2 rounded hover:bg-slate-100 dark:hover:bg-slate-800">Sign out</button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- BANNERS -->
    <div id="emailBanner" class="hidden">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="mt-3 mb-0 card p-3 flex items-center justify-between">
          <div class="text-sm">Please verify your email to unlock all features. <span class="font-medium">Check your inbox</span> or resend below.</div>
          <div class="flex gap-2">
            <button id="resendVerify" class="btn btn-primary">Resend</button>
            <button id="dismissVerify" class="btn btn-ghost">Dismiss</button>
          </div>
        </div>
      </div>
    </div>

    <!-- LOGIN / SIGNUP VIEW -->
    <main id="authView" class="min-h-[calc(100vh-64px)] grid place-items-center px-4 py-10">
      <div class="relative w-full max-w-md">
        <div class="absolute -inset-1 rounded-3xl bg-gradient-to-br from-brand-400/30 via-fuchsia-400/30 to-cyan-400/30 blur-xl"></div>
        <div class="relative card p-6 sm:p-8">
          <div class="mx-auto h-14 w-14 rounded-2xl brand-gradient grid place-items-center text-white font-bold shadow-soft">TF</div>
          <h1 class="text-2xl font-bold mt-4 text-center">Welcome to TaskFlow</h1>
          <p class="text-center text-sm text-slate-500 dark:text-slate-400">Sign in or create your account</p>

          <div class="mt-6 space-y-3">
            <label class="block">
              <span class="text-sm">Email</span>
              <input id="authEmail" type="email" class="input mt-1" placeholder="you@example.com" autocomplete="username"/>
            </label>
            <label class="block">
              <span class="text-sm">Password</span>
              <input id="authPassword" type="password" class="input mt-1" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>
            </label>
            <button id="signInBtn" class="btn btn-primary w-full">Sign In</button>
            <button id="signUpBtn" class="btn w-full">Create Account</button>

            <div class="flex items-center justify-between text-sm">
              <button id="resetBtn" class="text-brand-600 hover:underline">Forgot password?</button>
              <div class="text-slate-500">Press <kbd class="kbd">Enter</kbd> to sign in</div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- APP VIEW -->
    <main id="appView" class="hidden">
      <div class="mx-auto w-full max-w-7xl px-4 sm:px-6 lg:px-8 py-6 space-y-6">

        <!-- DASHBOARD -->
        <section class="card p-5">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-xl font-semibold">Your Progress Dashboard</h2>
              <p class="text-sm text-slate-500 dark:text-slate-400">Track your productivity at a glance</p>
            </div>
            <div class="flex items-center gap-4">
              <div class="text-center border rounded-2xl px-5 py-3">
                <div class="text-xs text-slate-400">Completed</div>
                <div id="statCompleted" class="text-2xl font-bold">0</div>
              </div>
              <div class="text-center border rounded-2xl px-5 py-3">
                <div class="text-xs text-slate-400">Pending</div>
                <div id="statPending" class="text-2xl font-bold">0</div>
              </div>
              <div class="text-center border rounded-2xl px-5 py-3">
                <div class="text-xs text-slate-400">Total</div>
                <div id="statTotal" class="text-2xl font-bold">0</div>
              </div>
              <div class="relative grid place-items-center">
                <svg width="76" height="76" viewBox="0 0 120 120">
                  <circle cx="60" cy="60" r="52" stroke="currentColor" stroke-width="12" class="text-slate-200 dark:text-slate-700 fill-none"></circle>
                  <circle id="progressArc" cx="60" cy="60" r="52" stroke="#6366f1" stroke-width="12" stroke-linecap="round" class="fill-none"
                          stroke-dasharray="0 999" transform="rotate(-90 60 60)"></circle>
                  <text id="progressText" x="60" y="68" text-anchor="middle" font-size="22" class="fill-slate-700 dark:fill-slate-200 font-bold">0%</text>
                </svg>
              </div>
            </div>
          </div>
        </section>

        <!-- CONTROLS -->
        <section class="card p-4 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
          <div class="flex items-center gap-2">
            <button data-filter="all" class="filterBtn chip chip-slate">All <span id="cntAll" class="ml-1 kbd">0</span></button>
            <button data-filter="pending" class="filterBtn chip chip-amber">Pending <span id="cntPending" class="ml-1 kbd">0</span></button>
            <button data-filter="completed" class="filterBtn chip chip-green">Completed <span id="cntCompleted" class="ml-1 kbd">0</span></button>
          </div>

          <div class="flex items-center gap-2">
            <div class="relative">
              <input id="searchInput" class="input pl-10 w-72" placeholder="Search tasks‚Ä¶ (/)">
              <div class="absolute left-3 top-2.5 text-slate-400">üîé</div>
            </div>
            <select id="sortSelect" class="input w-48">
              <option value="createdDesc">Sort: Newest</option>
              <option value="createdAsc">Sort: Oldest</option>
              <option value="dueAsc">Sort: Due (Soonest)</option>
              <option value="dueDesc">Sort: Due (Latest)</option>
              <option value="priority">Sort: Priority</option>
            </select>
            <button id="clearCompletedBtn" class="btn btn-ghost border">Clear Completed</button>
            <button id="newTaskFab" class="btn btn-primary">+ New Task <span class="ml-2 kbd">N</span></button>
          </div>
        </section>

        <!-- TASKS -->
        <section id="taskList" class="space-y-3"></section>

        <!-- EMPTY STATE -->
        <section id="emptyState" class="card py-16 grid place-items-center text-center hidden">
          <div class="text-6xl mb-3">üìù</div>
          <h3 class="text-xl font-semibold">No tasks yet</h3>
          <p class="text-slate-500 dark:text-slate-400">Click <span class="kbd">New Task</span> to get started on your productivity journey!</p>
        </section>
      </div>
    </main>

    <!-- TASK MODAL -->
    <dialog id="taskModal" class="backdrop:bg-black/50 rounded-2xl p-0 w-full max-w-lg">
      <form id="taskForm" class="card p-5">
        <div class="flex items-center justify-between mb-2">
          <h3 id="taskModalTitle" class="text-lg font-semibold">Add New Task</h3>
          <button type="button" id="closeTaskModal" class="btn btn-ghost">‚úï</button>
        </div>
        <label class="block mb-3">
          <span class="text-sm">Title</span>
          <input required id="taskTitle" class="input mt-1" placeholder="Short, actionable title" />
        </label>
        <label class="block mb-3">
          <span class="text-sm">Description</span>
          <textarea id="taskDesc" class="input mt-1 h-24 resize-none" placeholder="Optional details‚Ä¶"></textarea>
        </label>
        <div class="grid sm:grid-cols-3 gap-3">
          <label class="block">
            <span class="text-sm">Priority</span>
            <select id="taskPriority" class="input mt-1">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">Due Date</span>
            <input id="taskDue" type="date" class="input mt-1"/>
          </label>
          <label class="block">
            <span class="text-sm">Status</span>
            <select id="taskStatus" class="input mt-1">
              <option value="pending">Pending</option>
              <option value="completed">Completed</option>
            </select>
          </label>
        </div>
        <div class="mt-5 flex items-center justify-between">
          <button type="button" id="deleteTaskBtn" class="btn btn-ghost hidden">üóë Delete</button>
          <div class="ml-auto flex gap-2">
            <button type="button" id="saveDraftBtn" class="btn btn-ghost">Save draft</button>
            <button id="saveTaskBtn" type="submit" class="btn btn-primary">Save Task</button>
          </div>
        </div>
        <input type="hidden" id="taskId" />
      </form>
    </dialog>

    <!-- AI CHATBOT -->
    <button id="chatOpen" class="fixed bottom-6 right-6 brand-gradient text-white h-14 w-14 rounded-full grid place-items-center shadow-xl">ü§ñ</button>
    <dialog id="chatDialog" class="backdrop:bg-black/50 rounded-2xl p-0 w-full max-w-md">
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <div class="font-semibold">TaskFlow Assistant</div>
          <button id="chatClose" class="btn btn-ghost">‚úï</button>
        </div>
        <div id="chatLog" class="mt-3 h-72 overflow-auto space-y-2 text-sm"></div>
        <form id="chatForm" class="mt-3 flex gap-2">
          <input id="chatInput" class="input flex-1" placeholder="Ask me to add, list, or summarize your tasks‚Ä¶" />
          <button class="btn btn-primary">Send</button>
        </form>
        <p class="mt-2 text-[11px] text-slate-500">Tip: try ‚Äúadd task Buy milk tomorrow high priority‚Äù, ‚Äúwhat‚Äôs due today?‚Äù, ‚Äúhow many pending tasks?‚Äù.</p>
      </div>
    </dialog>

  </div>

  <!-- Firebase (v10+) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword,
      createUserWithEmailAndPassword, sendEmailVerification,
      sendPasswordResetEmail, signOut, setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, query, where,
      orderBy, serverTimestamp, updateDoc, doc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* -------------------- CONFIG (REPLACE THIS) -------------------- */
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID",
    };
    /* --------------------------------------------------------------- */

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence);

    /* -------------------- ELEMENTS -------------------- */
    const authView = document.getElementById('authView');
    const appView  = document.getElementById('appView');
    const emailBanner = document.getElementById('emailBanner');
    const userEmailUI = document.getElementById('userEmail');

    const signInBtn = document.getElementById('signInBtn');
    const signUpBtn = document.getElementById('signUpBtn');
    const resetBtn  = document.getElementById('resetBtn');
    const authEmail = document.getElementById('authEmail');
    const authPassword = document.getElementById('authPassword');

    const profileBtn  = document.getElementById('profileBtn');
    const profileMenu = document.getElementById('profileMenu');
    const signOutBtn  = document.getElementById('signOutBtn');
    const verifyEmailBtn = document.getElementById('verifyEmailBtn');
    const resendVerify = document.getElementById('resendVerify');
    const dismissVerify = document.getElementById('dismissVerify');

    const progressArc  = document.getElementById('progressArc');
    const progressText = document.getElementById('progressText');
    const statCompleted = document.getElementById('statCompleted');
    const statPending = document.getElementById('statPending');
    const statTotal = document.getElementById('statTotal');

    const taskList = document.getElementById('taskList');
    const emptyState = document.getElementById('emptyState');
    const filterBtns = [...document.querySelectorAll('.filterBtn')];
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const newTaskFab = document.getElementById('newTaskFab');
    const clearCompletedBtn = document.getElementById('clearCompletedBtn');

    const taskModal = document.getElementById('taskModal');
    const taskForm  = document.getElementById('taskForm');
    const taskModalTitle = document.getElementById('taskModalTitle');
    const closeTaskModal = document.getElementById('closeTaskModal');
    const deleteTaskBtn = document.getElementById('deleteTaskBtn');
    const saveDraftBtn = document.getElementById('saveDraftBtn');

    const taskIdInput = document.getElementById('taskId');
    const taskTitle   = document.getElementById('taskTitle');
    const taskDesc    = document.getElementById('taskDesc');
    const taskPriority= document.getElementById('taskPriority');
    const taskDue     = document.getElementById('taskDue');
    const taskStatus  = document.getElementById('taskStatus');

    const themeToggle = document.getElementById('themeToggle');
    const exportBtn   = document.getElementById('exportBtn');
    const importFile  = document.getElementById('importFile');

    const chatOpen = document.getElementById('chatOpen');
    const chatDialog = document.getElementById('chatDialog');
    const chatClose = document.getElementById('chatClose');
    const chatForm  = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const chatLog   = document.getElementById('chatLog');

    /* -------------------- THEME -------------------- */
    const THEME_KEY = 'tf-theme';
    const applyTheme = (t) => {
      if (t === 'dark') document.documentElement.classList.add('dark');
      else document.documentElement.classList.remove('dark');
      localStorage.setItem(THEME_KEY, t);
    };
    applyTheme(localStorage.getItem(THEME_KEY) || 'light');
    themeToggle.addEventListener('click', () => {
      const isDark = document.documentElement.classList.contains('dark');
      applyTheme(isDark ? 'light' : 'dark');
    });

    /* -------------------- AUTH -------------------- */
    const uiState = { user: null, filter: 'all', tasks: [], search: '', sort: 'createdDesc' };

    onAuthStateChanged(auth, async (user) => {
      uiState.user = user || null;
      if (user) {
        authView.classList.add('hidden');
        appView.classList.remove('hidden');
        userEmailUI.textContent = user.email || '';
        toggleVerifyBanner();
        await loadTasks();
      } else {
        authView.classList.remove('hidden');
        appView.classList.add('hidden');
      }
    });

    const signIn = async () => {
      const email = authEmail.value.trim();
      const pass  = authPassword.value;
      if (!email || !pass) return toast('Enter email & password');
      await signInWithEmailAndPassword(auth, email, pass).catch(e => toast(e.message));
    };
    const signUp = async () => {
      const email = authEmail.value.trim();
      const pass  = authPassword.value;
      if (!email || pass.length < 6) return toast('Use a stronger password (6+).');
      const cred = await createUserWithEmailAndPassword(auth, email, pass).catch(e => toast(e.message));
      if (cred?.user) {
        await sendEmailVerification(cred.user);
        toast('Verification email sent.');
      }
    };
    const resetPassword = async () => {
      const email = authEmail.value.trim();
      if (!email) return toast('Enter your email first.');
      await sendPasswordResetEmail(auth, email).then(() => toast('Password reset email sent.')).catch(e => toast(e.message));
    };
    signInBtn.addEventListener('click', signIn);
    signUpBtn.addEventListener('click', signUp);
    resetBtn.addEventListener('click', resetPassword);
    authPassword.addEventListener('keydown', e => { if (e.key === 'Enter') signIn(); });
    signOutBtn.addEventListener('click', () => signOut(auth));
    verifyEmailBtn.addEventListener('click', () => auth.currentUser && sendEmailVerification(auth.currentUser).then(()=>toast('Verification sent.')));
    resendVerify.addEventListener('click', () => verifyEmailBtn.click());
    dismissVerify.addEventListener('click', () => emailBanner.classList.add('hidden'));
    profileBtn.addEventListener('click', () => profileMenu.classList.toggle('hidden'));
    document.addEventListener('click', (e) => { if (!profileBtn.contains(e.target) && !profileMenu.contains(e.target)) profileMenu.classList.add('hidden'); });

    function toggleVerifyBanner() {
      const show = uiState.user && !uiState.user.emailVerified;
      emailBanner.classList.toggle('hidden', !show);
    }

    /* -------------------- FIRESTORE / TASKS -------------------- */
    const col = () => collection(db, 'users', uiState.user.uid, 'tasks');

    async function loadTasks() {
      const qs = await getDocs(query(col()));
      uiState.tasks = qs.docs.map(d => ({ id: d.id, ...d.data() }));
      render();
      scheduleDueNotifications();
    }

    function taskCard(t) {
      const dueStr = t.dueDate ? new Date(t.dueDate).toLocaleDateString() : '‚Äî';
      const priorityChip = t.priority === 'high' ? 'chip-amber' : (t.priority === 'low' ? 'chip-slate' : 'chip-green');
      const status = t.status === 'completed';

      return `
        <div class="card p-4 flex gap-3 items-start">
          <input type="checkbox" data-id="${t.id}" class="toggleStatus mt-1.5 h-5 w-5 rounded border-slate-300" ${status ? 'checked' : ''}/>
          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between">
              <h4 class="font-semibold ${status ? 'line-through text-slate-400' : ''}">${escapeHtml(t.title)}</h4>
              <div class="flex items-center gap-2">
                <span class="chip ${priorityChip} capitalize">${t.priority}</span>
                <span class="chip chip-slate">Due: ${dueStr}</span>
              </div>
            </div>
            ${t.description ? `<p class="mt-1 text-sm text-slate-600 dark:text-slate-300">${escapeHtml(t.description)}</p>` : ''}
            <div class="mt-2 flex items-center gap-2 text-sm">
              <button class="editBtn btn btn-ghost border" data-id="${t.id}">‚úèÔ∏è Edit</button>
              <button class="delBtn btn btn-ghost border" data-id="${t.id}">üóë Delete</button>
            </div>
          </div>
        </div>
      `;
    }

    function render() {
      const q = uiState.search.toLowerCase();
      const filtered = uiState.tasks.filter(t => {
        const matchText = t.title.toLowerCase().includes(q) || (t.description||'').toLowerCase().includes(q);
        const matchFilter = uiState.filter === 'all' ? true : uiState.filter === t.status;
        return matchText && matchFilter;
      });

      filtered.sort((a,b) => {
        switch (uiState.sort) {
          case 'createdAsc':  return (a.createdAt?.seconds||0) - (b.createdAt?.seconds||0);
          case 'createdDesc': return (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0);
          case 'dueAsc':      return (new Date(a.dueDate||'9999-12-31')) - (new Date(b.dueDate||'9999-12-31'));
          case 'dueDesc':     return (new Date(b.dueDate||'9999-12-31')) - (new Date(a.dueDate||'9999-12-31'));
          case 'priority': {
            const rank = { high: 0, medium: 1, low: 2 };
            return (rank[a.priority] ?? 9) - (rank[b.priority] ?? 9);
          }
        }
        return 0;
      });

      taskList.innerHTML = filtered.map(taskCard).join('');
      const total = uiState.tasks.length;
      const completed = uiState.tasks.filter(t=>t.status==='completed').length;
      const pending = total - completed;

      statTotal.textContent = total;
      statCompleted.textContent = completed;
      statPending.textContent = pending;
      document.getElementById('cntAll').textContent = total;
      document.getElementById('cntCompleted').textContent = completed;
      document.getElementById('cntPending').textContent = pending;

      // Empty state toggle
      emptyState.classList.toggle('hidden', !!filtered.length || !!total);
      if (!total) emptyState.classList.remove('hidden');

      // Progress ring
      const pct = total ? Math.round((completed / total) * 100) : 0;
      progressText.textContent = pct + '%';
      const circumference = 2 * Math.PI * 52;
      const dash = (pct / 100) * circumference;
      progressArc.setAttribute('stroke-dasharray', `${dash} ${circumference - dash}`);

      // bind row actions
      [...taskList.querySelectorAll('.editBtn')].forEach(el => el.addEventListener('click', () => openEdit(el.dataset.id)));
      [...taskList.querySelectorAll('.delBtn')].forEach(el => el.addEventListener('click', () => removeTask(el.dataset.id)));
      [...taskList.querySelectorAll('.toggleStatus')].forEach(el => el.addEventListener('change', () => toggleStatus(el.dataset.id, el.checked)));
    }

    async function toggleStatus(id, checked) {
      await updateDoc(doc(db, 'users', uiState.user.uid, 'tasks', id), { status: checked ? 'completed' : 'pending' });
      await loadTasks();
    }

    async function removeTask(id) {
      if (!confirm('Delete this task?')) return;
      await deleteDoc(doc(db, 'users', uiState.user.uid, 'tasks', id));
      await loadTasks();
    }

    function openNew() {
      taskForm.reset();
      taskIdInput.value = '';
      taskModalTitle.textContent = 'Add New Task';
      deleteTaskBtn.classList.add('hidden');
      taskModal.showModal();
    }
    function openEdit(id) {
      const t = uiState.tasks.find(x => x.id === id);
      if (!t) return;
      taskIdInput.value = t.id;
      taskTitle.value = t.title || '';
      taskDesc.value = t.description || '';
      taskPriority.value = t.priority || 'medium';
      taskDue.value = t.dueDate || '';
      taskStatus.value = t.status || 'pending';
      taskModalTitle.textContent = 'Edit Task';
      deleteTaskBtn.classList.remove('hidden');
      taskModal.showModal();
    }

    taskForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        title: taskTitle.value.trim(),
        description: taskDesc.value.trim(),
        priority: taskPriority.value,
        dueDate: taskDue.value || null,
        status: taskStatus.value,
        updatedAt: serverTimestamp(),
      };
      if (!payload.title) return toast('Title is required.');
      const id = taskIdInput.value;
      if (id) {
        await updateDoc(doc(db, 'users', uiState.user.uid, 'tasks', id), payload);
      } else {
        await addDoc(col(), { ...payload, createdAt: serverTimestamp() });
      }
      taskModal.close();
      await loadTasks();
    });
    closeTaskModal.addEventListener('click', () => taskModal.close());
    deleteTaskBtn.addEventListener('click', async () => {
      const id = taskIdInput.value;
      if (!id) return;
      await removeTask(id);
      taskModal.close();
    });
    saveDraftBtn.addEventListener('click', () => { toast('Draft saved locally.'); localStorage.setItem('tf-draft', JSON.stringify({ title: taskTitle.value, description: taskDesc.value, priority: taskPriority.value, dueDate: taskDue.value, status: taskStatus.value })); });
    if (localStorage.getItem('tf-draft')) {
      try {
        const d = JSON.parse(localStorage.getItem('tf-draft'));
        taskTitle.value = d.title||''; taskDesc.value = d.description||''; taskPriority.value=d.priority||'medium'; taskDue.value=d.dueDate||''; taskStatus.value=d.status||'pending';
      } catch {}
    }

    newTaskFab.addEventListener('click', openNew);
    filterBtns.forEach(btn => btn.addEventListener('click', () => { uiState.filter = btn.dataset.filter; render(); }));
    searchInput.addEventListener('input', () => { uiState.search = searchInput.value; render(); });
    sortSelect.addEventListener('change', () => { uiState.sort = sortSelect.value; render(); });
    clearCompletedBtn.addEventListener('click', async () => {
      const completed = uiState.tasks.filter(t => t.status==='completed');
      if (!completed.length) return toast('Nothing to clear.');
      if (!confirm(`Delete ${completed.length} completed task(s)?`)) return;
      await Promise.all(completed.map(t => deleteDoc(doc(db, 'users', uiState.user.uid, 'tasks', t.id))));
      await loadTasks();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key.toLowerCase() === 'n') { openNew(); e.preventDefault(); }
      if (e.key === '/' && document.activeElement !== searchInput) { searchInput.focus(); e.preventDefault(); }
    });

    /* -------------------- EXPORT / IMPORT -------------------- */
    exportBtn.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(uiState.tasks, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `taskflow-tasks-${new Date().toISOString().slice(0,10)}.json`; a.click();
      URL.revokeObjectURL(url);
    });
    importFile.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const text = await file.text();
      let arr = [];
      try {
        if (file.name.endsWith('.csv')) arr = csvToTasks(text);
        else arr = JSON.parse(text);
      } catch { return toast('Invalid file.'); }
      if (!Array.isArray(arr)) return toast('Invalid format.');
      const cleaned = arr.map(t => ({
        title: t.title?.toString()?.slice(0,200) || 'Untitled',
        description: (t.description||'').toString().slice(0,2000),
        priority: ['low','medium','high'].includes((t.priority||'').toLowerCase()) ? t.priority : 'medium',
        dueDate: t.dueDate || null,
        status: t.status==='completed' ? 'completed' : 'pending',
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      }));
      await Promise.all(cleaned.map(t => addDoc(col(), t)));
      toast(`Imported ${cleaned.length} task(s).`);
      await loadTasks();
      e.target.value = '';
    });

    function csvToTasks(csv) {
      const [h, ...rows] = csv.trim().split(/\r?\n/).map(r => r.split(','));
      const idx = (k) => h.findIndex(x => x.trim().toLowerCase()===k);
      return rows.map(r => ({
        title: r[idx('title')],
        description: r[idx('description')],
        priority: r[idx('priority')],
        dueDate: r[idx('duedate')],
        status: r[idx('status')],
      }));
    }

    /* -------------------- NOTIFICATIONS -------------------- */
    async function scheduleDueNotifications() {
      if (!('Notification' in window)) return;
      if (Notification.permission === 'default') await Notification.requestPermission();
      if (Notification.permission !== 'granted') return;
      const soon = uiState.tasks.filter(t => t.dueDate && t.status!=='completed');
      soon.forEach(t => {
        const ms = new Date(t.dueDate).getTime() - Date.now();
        if (ms > 0 && ms < 1000 * 60 * 60 * 24) { // within next 24h
          setTimeout(() => new Notification('Task due soon', { body: t.title }), Math.min(ms, 2147483647));
        }
      });
    }

    /* -------------------- AI HELPER (RULE-BASED) -------------------- */
    chatOpen.addEventListener('click', () => chatDialog.showModal());
    chatClose.addEventListener('click', () => chatDialog.close());
    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = chatInput.value.trim();
      if (!msg) return;
      addChat('user', msg);
      chatInput.value = '';
      const res = await aiRespond(msg);
      addChat('bot', res);
    });

    function addChat(role, text) {
      const b = document.createElement('div');
      b.className = role === 'user' ? 'text-right' : '';
      b.innerHTML = `<div class="inline-block max-w-[85%] ${role==='user'?'bg-brand-600 text-white':'bg-slate-100 dark:bg-slate-800'} px-3 py-2 rounded-2xl">${escapeHtml(text)}</div>`;
      chatLog.appendChild(b); chatLog.scrollTop = chatLog.scrollHeight;
    }

    async function aiRespond(input) {
      const text = input.toLowerCase();

      // Add task: "add task <title> [tomorrow|today|on <date>] [high|medium|low]"
      if (text.startsWith('add task')) {
        const m = /add task\s+(.+)/i.exec(input);
        let title = m ? m[1] : 'New Task';
        let priority = 'medium';
        let due = null;

        if (/ high\b/i.test(title)) { priority='high'; title=title.replace(/ high\b/i,''); }
        if (/ low\b/i.test(title)) { priority='low'; title=title.replace(/ low\b/i,''); }
        if (/ medium\b/i.test(title)) { priority='medium'; title=title.replace(/ medium\b/i,''); }
        if (/ tomorrow\b/i.test(title)) { const d = new Date(); d.setDate(d.getDate()+1); due = d.toISOString().slice(0,10); title=title.replace(/ tomorrow\b/i,''); }
        if (/ today\b/i.test(title)) { due = new Date().toISOString().slice(0,10); title=title.replace(/ today\b/i,''); }
        const onDate = / on (\d{4}-\d{2}-\d{2})/i.exec(title);
        if (onDate) { due = onDate[1]; title = title.replace(onDate[0],''); }

        await addDoc(col(), { title: title.trim(), description: '', priority, dueDate: due, status: 'pending', createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
        await loadTasks();
        return `Added task: ‚Äú${title.trim()}‚Äù ${due ? `due ${due}`:''} (${priority}).`;
      }

      if (/how many pending/.test(text) || /pending count/.test(text)) {
        const n = uiState.tasks.filter(t=>t.status==='pending').length;
        return `You have ${n} pending task${n===1?'':'s'}.`;
      }
      if (/how many completed/.test(text) || /done count/.test(text)) {
        const n = uiState.tasks.filter(t=>t.status==='completed').length;
        return `You‚Äôve completed ${n} task${n===1?'':'s'}.`;
      }
      if (/list (my )?tasks|show tasks/.test(text)) {
        const top = uiState.tasks.slice(0,5).map(t => `‚Ä¢ ${t.title}${t.dueDate?` (due ${t.dueDate})`:''}`).join('\n');
        return top || 'No tasks yet.';
      }
      if (/what's due today|due today|today's tasks/.test(text)) {
        const today = new Date().toISOString().slice(0,10);
        const list = uiState.tasks.filter(t=>t.dueDate===today && t.status!=='completed').map(t=>`‚Ä¢ ${t.title}`).join('\n');
        return list || 'Nothing due today üéâ';
      }

      return "I can add tasks, list them, and summarize. Try: ‚Äúadd task Buy milk tomorrow high priority‚Äù, ‚Äúwhat's due today?‚Äù, or ‚Äúhow many pending tasks?‚Äù.";
    }

    /* -------------------- UTILS -------------------- */
    function toast(msg) {
      const d = document.createElement('div');
      d.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 px-4 py-2 rounded-xl text-white bg-slate-900/90 shadow-xl z-[9999]';
      d.textContent = msg; document.body.appendChild(d);
      setTimeout(()=>d.remove(), 2400);
    }
    function escapeHtml(s='') {
      return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }

    // Init helpers
    newTaskFab.title = 'New Task (N)';
    searchInput.title = 'Press / to focus';

  </script>
</body>
</html>
