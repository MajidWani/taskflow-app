<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TaskFlow — Personal Task Manager</title>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --grad: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    }
    body{ background: #f6f7fb; min-height:100vh; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body.dark{ background:#0f172a; color:#e5e7eb; }
    .glass { background: rgba(255,255,255,.7); backdrop-filter: blur(10px); }
    .dark .glass { background: rgba(30,41,59,.6); }
    .btn-primary{ background: linear-gradient(90deg,#2563eb,#7c3aed); color:white;}
    .btn-primary:hover{ filter:brightness(1.05); transform: translateY(-1px); }
    .ring-wrap{ position:relative; width:120px; height:120px; }
    .ring{ stroke-linecap:round; transition: 0.4s stroke-dashoffset; }
    .ring-text{ position:absolute; inset:0; display:grid; place-items:center; font-weight:700; }
    .token{ padding:.15rem .5rem; border-radius:.5rem; font-size:.75rem; font-weight:600; }
    .token.low{ background:#ecfeff; color:#0891b2; }      .dark .token.low{ background:#083344; color:#a5f3fc;}
    .token.med{ background:#eef2ff; color:#4f46e5; }      .dark .token.med{ background:#1e1b4b; color:#c7d2fe;}
    .token.high{background:#fef2f2; color:#dc2626; }      .dark .token.high{ background:#450a0a; color:#fecaca;}
    .token.tag{ background:#f1f5f9; color:#0f172a;}       .dark .token.tag{ background:#1f2937; color:#e5e7eb;}
    .token.duedate{ background:#fff7ed; color:#c2410c; }  .dark .token.duedate{ background:#451a03; color:#fdba74;}
    .switcher button.active{ background:var(--grad); color:white; }
    .kbd{ border:1px solid #cbd5e1; border-bottom-width:3px; padding:.1rem .35rem; border-radius:.35rem; font-size:.75rem;}
    .dark .kbd{ border-color:#334155;}
    .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.35); }
    .modal.open{ display:grid; }
    .modal-card{ width:100%; max-width:560px; }
  </style>
</head>

<body class="min-h-screen">
  <!-- Auth Shell -->
  <div id="authShell" class="min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-md glass rounded-2xl shadow-xl p-8">
      <div class="flex items-center justify-center mb-6">
        <div class="w-12 h-12 rounded-xl flex items-center justify-center text-white font-bold" style="background:var(--grad)">TF</div>
      </div>
      <h1 class="text-2xl font-bold text-center mb-2">TaskFlow</h1>
      <p class="text-center text-slate-500 dark:text-slate-300 mb-6">Welcome back! Please sign in to your account.</p>

      <!-- Login -->
      <form id="loginForm" class="space-y-3">
        <div>
          <label class="text-sm font-medium">Email</label>
          <input id="loginEmail" type="email" class="mt-1 w-full rounded-lg border px-3 py-2 bg-white dark:bg-slate-700 dark:border-slate-600" required />
        </div>
        <div>
          <label class="text-sm font-medium">Password</label>
          <input id="loginPassword" type="password" class="mt-1 w-full rounded-lg border px-3 py-2 bg-white dark:bg-slate-700 dark:border-slate-600" required />
        </div>
        <p id="loginError" class="hidden text-red-600 text-sm"></p>
        <p id="loginSuccess" class="hidden text-green-600 text-sm"></p>
        <button id="loginBtn" class="btn-primary w-full py-3 rounded-lg font-semibold transition"><span class="btn-text">Sign In</span></button>
      </form>

      <div class="mt-4 text-sm flex items-center justify-between">
        <button class="underline" onclick="showForgot()">Forgot password?</button>
        <button class="underline" onclick="showSignup()">Create account</button>
      </div>

      <div class="mt-6 text-center">
        <button id="toggleDark" class="text-sm px-3 py-1 rounded-lg border">Toggle dark</button>
      </div>
    </div>
  </div>

  <!-- Signup -->
  <div id="signupShell" class="min-h-screen hidden items-center justify-center p-6">
    <div class="w-full max-w-md glass rounded-2xl shadow-xl p-8">
      <h2 class="text-xl font-bold mb-1">Create your account</h2>
      <p class="text-slate-500 dark:text-slate-300 mb-5">Join TaskFlow and get productive.</p>
      <form id="signupForm" class="space-y-3">
        <div>
          <label class="text-sm font-medium">Name</label>
          <input id="signupName" class="mt-1 w-full rounded-lg border px-3 py-2 bg-white dark:bg-slate-700 dark:border-slate-600" required />
        </div>
        <div>
          <label class="text-sm font-medium">Email</label>
          <input id="signupEmail" type="email" class="mt-1 w-full rounded-lg border px-3 py-2 bg-white dark:bg-slate-700 dark:border-slate-600" required />
        </div>
        <div>
          <label class="text-sm font-medium">Password</label>
          <input id="signupPassword" type="password" class="mt-1 w-full rounded-lg border px-3 py-2 bg-white dark:bg-slate-700 dark:border-slate-600" required />
          <div id="passwordStrength" class="text-xs mt-1"></div>
        </div>
        <div>
          <label class="text-sm font-medium">Confirm Password</label>
          <input id="confirmSignupPassword" type="password" class="mt-1 w-full rounded-lg border px-3 py-2 bg-white dark:bg-slate-700 dark:border-slate-600" required />
          <div id="confirmPasswordMessage" class="text-xs mt-1"></div>
        </div>
        <p id="signupError" class="hidden text-red-600 text-sm"></p>
        <p id="signupSuccess" class="hidden text-green-600 text-sm"></p>
        <button id="signupBtn" class="btn-primary w-full py-3 rounded-lg font-semibold transition"><span class="btn-text">Create Account</span></button>
      </form>
      <div class="mt-4 text-sm">
        <button class="underline" onclick="showLogin()">Back to sign in</button>
      </div>
    </div>
  </div>

  <!-- Forgot -->
  <div id="forgotShell" class="min-h-screen hidden items-center justify-center p-6">
    <div class="w-full max-w-md glass rounded-2xl shadow-xl p-8">
      <h2 class="text-xl font-bold mb-1">Reset password</h2>
      <p class="text-slate-500 dark:text-slate-300 mb-5">We’ll send a reset link to your email.</p>
      <form id="forgotPasswordForm" class="space-y-3">
        <div>
          <label class="text-sm font-medium">Email</label>
          <input id="forgotEmail" type="email" class="mt-1 w-full rounded-lg border px-3 py-2 bg-white dark:bg-slate-700 dark:border-slate-600" required />
        </div>
        <p id="forgotError" class="hidden text-red-600 text-sm"></p>
        <p id="forgotSuccess" class="hidden text-green-600 text-sm"></p>
        <button id="forgotBtn" class="btn-primary w-full py-3 rounded-lg font-semibold transition"><span class="btn-text">Send Reset Email</span></button>
      </form>
      <div class="mt-4 text-sm">
        <button class="underline" onclick="showLogin()">Back to sign in</button>
      </div>
    </div>
  </div>

  <!-- Verify Email -->
  <div id="verifyShell" class="min-h-screen hidden items-center justify-center p-6">
    <div class="w-full max-w-md glass rounded-2xl shadow-xl p-8">
      <h2 class="text-xl font-bold mb-1">Verify your email</h2>
      <p class="text-slate-500 dark:text-slate-300">We sent a link to <strong id="verificationEmail"></strong>.</p>
      <div class="space-y-2 mt-4">
        <button id="resendBtn" class="w-full border rounded-lg py-2">Resend verification email</button>
        <button id="checkVerificationBtn" class="btn-primary w-full py-2 rounded-lg"><span class="btn-text">I've Verified My Email</span></button>
      </div>
      <p id="verificationError" class="hidden text-red-600 text-sm mt-3"></p>
      <p id="verificationSuccess" class="hidden text-green-600 text-sm mt-3"></p>
      <div class="mt-4 text-sm">
        <button class="underline" onclick="showLogin()">Back to sign in</button>
      </div>
    </div>
  </div>

  <!-- App -->
  <div id="appShell" class="hidden min-h-screen">
    <header class="px-6 sm:px-10 py-5 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-lg flex items-center justify-center text-white font-bold" style="background:var(--grad)">TF</div>
        <div class="font-semibold">TaskFlow</div>
        <span class="hidden sm:inline text-slate-500 dark:text-slate-300">— your personal task hub</span>
      </div>
      <div class="flex items-center gap-3">
        <button class="px-3 py-1 rounded-lg border" id="darkBtn" title="Dark mode (D)">Dark</button>
        <button class="px-3 py-1 rounded-lg border" onclick="exportTasks()">Export</button>
        <label class="px-3 py-1 rounded-lg border cursor-pointer">
          Import<input type="file" accept="application/json" class="hidden" onchange="importTasks(this.files[0])"/>
        </label>
        <div class="px-3 py-1 rounded-lg border text-sm" id="userEmailBadge"></div>
        <button class="px-3 py-1 rounded-lg border" onclick="logout()">Sign out</button>
      </div>
    </header>

    <main class="px-6 sm:px-10 pb-20">
      <!-- Dashboard -->
      <div class="glass rounded-2xl p-6 sm:p-8 shadow-xl">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
          <div>
            <h2 class="text-xl font-bold">Your Progress Dashboard</h2>
            <p class="text-slate-500 dark:text-slate-300">Track your productivity at a glance</p>
          </div>

          <div class="flex items-center gap-8">
            <div class="ring-wrap">
              <svg viewBox="0 0 120 120">
                <circle cx="60" cy="60" r="52" stroke="#e5e7eb" stroke-width="12" fill="none" class="dark:stroke-slate-700"/>
                <circle id="ring" cx="60" cy="60" r="52" stroke="#7c3aed" stroke-width="12" fill="none" class="ring"
                        stroke-dasharray="327" stroke-dashoffset="327" />
              </svg>
              <div class="ring-text"><span id="ringText">0%</span></div>
            </div>

            <div class="grid grid-cols-3 gap-3">
              <div class="px-4 py-3 rounded-xl border">
                <div class="text-xs text-slate-500 dark:text-slate-300">Completed</div>
                <div class="text-2xl font-bold" id="statCompleted">0</div>
              </div>
              <div class="px-4 py-3 rounded-xl border">
                <div class="text-xs text-slate-500 dark:text-slate-300">Pending</div>
                <div class="text-2xl font-bold" id="statPending">0</div>
              </div>
              <div class="px-4 py-3 rounded-xl border">
                <div class="text-xs text-slate-500 dark:text-slate-300">Total</div>
                <div class="text-2xl font-bold" id="statTotal">0</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="mt-6 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
          <div class="flex items-center gap-2 switcher">
            <button id="filterAll" class="px-3 py-1 rounded-lg border active" onclick="setFilter('all')">All <span class="ml-1 text-xs" id="countAll">0</span></button>
            <button id="filterPending" class="px-3 py-1 rounded-lg border" onclick="setFilter('pending')">Pending <span class="ml-1 text-xs" id="countPending">0</span></button>
            <button id="filterCompleted" class="px-3 py-1 rounded-lg border" onclick="setFilter('completed')">Completed <span class="ml-1 text-xs" id="countCompleted">0</span></button>
            <button class="px-3 py-1 rounded-lg border" onclick="completeAll()">Complete all</button>
            <button id="clearCompletedBtn" class="px-3 py-1 rounded-lg border" onclick="clearCompleted()" disabled>Clear completed</button>
          </div>

          <div class="flex items-center gap-2">
            <div class="relative">
              <input id="searchInput" placeholder="Search tasks… (/)" class="w-72 max-w-full pl-9 py-2 rounded-lg border bg-white dark:bg-slate-700 dark:border-slate-600"/>
              <svg class="w-4 h-4 absolute left-3 top-2.5 opacity-60" viewBox="0 0 20 20" fill="currentColor"><path d="M12.9 14.32a8 8 0 1 1 1.414-1.414l4.387 4.387-1.414 1.414-4.387-4.387ZM14 8a6 6 0 1 0-12 0 6 6 0 0 0 12 0Z"/></svg>
            </div>
            <select id="sortBy" class="px-3 py-2 rounded-lg border bg-white dark:bg-slate-700 dark:border-slate-600" onchange="render()">
              <option value="created">Sort: Created</option>
              <option value="due">Sort: Due date</option>
              <option value="priority">Sort: Priority</option>
            </select>
            <button class="btn-primary px-4 py-2 rounded-lg font-semibold" onclick="openModal()" title="New task (N)">+ New Task</button>
          </div>
        </div>

        <!-- List -->
        <div id="list" class="mt-5 grid gap-3"></div>

        <!-- Empty -->
        <div id="empty" class="hidden text-center py-16">
          <div class="text-5xl mb-3">📝</div>
          <div class="text-lg font-semibold">No tasks yet</div>
          <p class="text-slate-500 dark:text-slate-300">Click “New Task” to start your productivity journey.</p>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="modal-card glass rounded-2xl shadow-xl p-6 sm:p-7" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold" id="modalTitle">Add Task</h3>
        <button class="px-2 py-1 rounded-lg border" onclick="closeModal()">Esc</button>
      </div>

      <form id="taskForm" class="space-y-4">
        <div>
          <label class="text-sm font-medium">Title</label>
          <input id="f_title" class="mt-1 w-full rounded-lg border px-3 py-2 bg-white dark:bg-slate-700 dark:border-slate-600" required />
        </div>
        <div>
          <label class="text-sm font-medium">Description</label>
          <textarea id="f_desc" class="mt-1 w-full rounded-lg border px-3 py-2 bg-white dark:bg-slate-700 dark:border-slate-600" rows="3"></textarea>
        </div>
        <div class="grid sm:grid-cols-3 gap-3">
          <div>
            <label class="text-sm font-medium">Priority</label>
            <select id="f_priority" class="mt-1 w-full rounded-lg border px-3 py-2 bg-white dark:bg-slate-700 dark:border-slate-600">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-medium">Due date</label>
            <input id="f_due" type="date" class="mt-1 w-full rounded-lg border px-3 py-2 bg-white dark:bg-slate-700 dark:border-slate-600"/>
          </div>
          <div>
            <label class="text-sm font-medium">Tags (comma separated)</label>
            <input id="f_tags" class="mt-1 w-full rounded-lg border px-3 py-2 bg-white dark:bg-slate-700 dark:border-slate-600" placeholder="work, personal"/>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <input id="f_remind" type="checkbox" class="h-4 w-4"/>
          <label for="f_remind" class="text-sm">Remind me on due date (browser notification)</label>
        </div>
        <div class="flex gap-2 justify-end pt-2">
          <button type="button" class="px-3 py-2 rounded-lg border" onclick="closeModal()">Cancel</button>
          <button id="saveBtn" class="btn-primary px-4 py-2 rounded-lg font-semibold">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    /* ---------------- Firebase ---------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyCvDSt9HnNH_3dPOtN90e6_0io9VgwgEck",
      authDomain: "taskflow-ebc4c.firebaseapp.com",
      projectId: "taskflow-ebc4c",
      storageBucket: "taskflow-ebc4c.firebasestorage.app",
      messagingSenderId: "172525838982",
      appId: "1:172525838982:web:e119eaba713848ca482707",
      measurementId: "G-DD2547X13J"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    /* ---------------- State ---------------- */
    let currentUser = null;
    let filter = 'all';
    let search = '';
    let editingId = null;

    /* ---------------- Storage (per-user localStorage) ---------------- */
    function key() {
      return currentUser ? `taskflow_tasks_${currentUser.uid}` : 'taskflow_tasks_guest';
    }
    const Store = {
      all() {
        try { return JSON.parse(localStorage.getItem(key())) || []; }
        catch { return []; }
      },
      save(tasks) { localStorage.setItem(key(), JSON.stringify(tasks)); },
      add(task) { const t = this.all(); t.unshift(task); this.save(t); return task; },
      update(id, patch) {
        const t = this.all();
        const i = t.findIndex(x=>x.id===id);
        if(i>-1){ t[i] = {...t[i], ...patch, updatedAt: new Date().toISOString()}; this.save(t); return t[i]; }
        return null;
      },
      remove(id) { const t = this.all().filter(x=>x.id!==id); this.save(t); },
      clearCompleted(){ const t=this.all(); const p=t.filter(x=>!x.completed); this.save(p); return t.length-p.length; },
      completeAll(){ const t=this.all().map(x=>({...x, completed:true})); this.save(t); }
    };

    /* ---------------- Helpers ---------------- */
    const qs = s => document.querySelector(s);
    const el = (tag, cls, html) => { const e = document.createElement(tag); if(cls) e.className=cls; if(html!=null) e.innerHTML=html; return e; };
    const fmtDate = d => d ? new Date(d).toLocaleDateString() : '—';
    const cmpPriority = p => ({high:0, medium:1, low:2})[p] ?? 1;

    function setButtonLoading(button, loading){
      const span = button.querySelector('.btn-text') || button;
      if(loading){ button.disabled=true; span.innerHTML = 'Loading…'; }
      else{ button.disabled=false; span.innerHTML = span.dataset.default || span.innerHTML; }
    }

    function updateProgress(){
      const tasks = visibleTasks();
      const all = Store.all();
      const total = all.length;
      const done = all.filter(t=>t.completed).length;
      const pending = total - done;

      // counts
      qs('#countAll').textContent = total;
      qs('#countPending').textContent = pending;
      qs('#countCompleted').textContent = done;
      qs('#statCompleted').textContent = done;
      qs('#statPending').textContent = pending;
      qs('#statTotal').textContent = total;

      // ring
      const pct = total ? Math.round((done/total)*100) : 0;
      qs('#ringText').textContent = pct + '%';
      const C = 2*Math.PI*52; // dasharray
      const off = C - (C * pct / 100);
      qs('#ring').style.strokeDasharray = C;
      qs('#ring').style.strokeDashoffset = off;

      // empty state + clear btn
      qs('#empty').classList.toggle('hidden', total !== 0);
      qs('#clearCompletedBtn').disabled = done === 0;
    }

    function visibleTasks(){
      const term = search.trim().toLowerCase();
      let tasks = Store.all();

      // filter
      if(filter === 'pending') tasks = tasks.filter(t=>!t.completed);
      else if(filter === 'completed') tasks = tasks.filter(t=>t.completed);

      // search
      if(term){
        tasks = tasks.filter(t => [t.title,t.description,(t.tags||[]).join(',')].join(' ').toLowerCase().includes(term));
      }

      // sort
      const sortBy = qs('#sortBy').value;
      tasks.sort((a,b)=>{
        if(sortBy==='due'){
          return (a.dueDate||'') > (b.dueDate||'') ? 1 : -1;
        }else if(sortBy==='priority'){
          return cmpPriority(a.priority) - cmpPriority(b.priority);
        }
        return (b.createdAt||'').localeCompare(a.createdAt||'');
      });
      return tasks;
    }

    function render(){
      const wrap = qs('#list');
      wrap.innerHTML = '';
      const tasks = visibleTasks();

      tasks.forEach(t=>{
        const card = el('div','border rounded-xl p-4 flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 bg-white dark:bg-slate-800 dark:border-slate-700');
        const left = el('div','flex gap-3 items-start');

        const chk = el('input'); chk.type='checkbox'; chk.checked = !!t.completed;
        chk.className = 'mt-1 h-5 w-5';
        chk.onchange = ()=>{ Store.update(t.id,{completed:chk.checked}); render(); };

        const info = el('div');
        const title = el('div','font-semibold'+(t.completed?' line-through opacity-60':''), t.title);
        const desc  = el('div','text-sm text-slate-500 dark:text-slate-300 mt-0.5', t.description || '');
        const row = el('div','flex flex-wrap gap-2 mt-2');

        const pr = el('span','token '+(t.priority==='high'?'high':t.priority==='low'?'low':'med'), t.priority[0].toUpperCase()+t.priority.slice(1));
        row.appendChild(pr);

        if(t.dueDate){
          row.appendChild(el('span','token duedate', 'Due: '+fmtDate(t.dueDate)));
        }
        (t.tags||[]).slice(0,6).forEach(tag=> row.appendChild(el('span','token tag','#'+tag)));

        info.appendChild(title); info.appendChild(desc); info.appendChild(row);
        left.appendChild(chk); left.appendChild(info);

        const right = el('div','flex items-center gap-2');
        const edit = el('button','px-3 py-1 rounded-lg border', 'Edit');
        edit.onclick = ()=> openModal(t);

        const del = el('button','px-3 py-1 rounded-lg border', 'Delete');
        del.onclick = ()=>{ if(confirm('Delete this task?')){ Store.remove(t.id); render(); } };

        right.appendChild(edit); right.appendChild(del);

        card.appendChild(left); card.appendChild(right);
        wrap.appendChild(card);
      });

      updateProgress();
    }

    function setFilter(f){
      filter = f;
      qs('#filterAll').classList.toggle('active', f==='all');
      qs('#filterPending').classList.toggle('active', f==='pending');
      qs('#filterCompleted').classList.toggle('active', f==='completed');
      render();
    }

    function clearCompleted(){
      const removed = Store.clearCompleted();
      if(removed) render();
    }
    function completeAll(){
      Store.completeAll(); render();
    }

    /* ---------------- Modal / CRUD ---------------- */
    function openModal(task=null){
      editingId = task?.id || null;
      qs('#modalTitle').textContent = editingId ? 'Edit Task' : 'Add Task';
      qs('#f_title').value = task?.title || '';
      qs('#f_desc').value = task?.description || '';
      qs('#f_priority').value = task?.priority || 'medium';
      qs('#f_due').value = task?.dueDate || '';
      qs('#f_tags').value = (task?.tags||[]).join(', ');
      qs('#f_remind').checked = !!task?.remind;
      qs('#modal').classList.add('open');
      setTimeout(()=>qs('#f_title').focus(),0);
    }
    function closeModal(){ qs('#modal').classList.remove('open'); }

    function readForm(){
      const tags = qs('#f_tags').value.split(',').map(s=>s.trim()).filter(Boolean);
      return {
        id: editingId || ('task_'+Date.now()+'_'+Math.random().toString(36).slice(2,8)),
        title: qs('#f_title').value.trim(),
        description: qs('#f_desc').value.trim(),
        priority: qs('#f_priority').value,
        dueDate: qs('#f_due').value || null,
        tags,
        remind: qs('#f_remind').checked,
        completed: false,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
    }

    qs('#taskForm').addEventListener('submit', e=>{
      e.preventDefault();
      const task = readForm();
      if(!task.title){ alert('Title is required'); return; }

      if(editingId){
        Store.update(editingId, task);
      }else{
        Store.add(task);
        if(task.remind && 'Notification' in window){
          try{
            Notification.requestPermission().then(perm=>{
              if(perm==='granted' && task.dueDate){
                const time = new Date(task.dueDate).getTime() - Date.now();
                if(time>0){
                  setTimeout(()=> new Notification('TaskFlow Reminder',{ body:`${task.title} is due today` }), Math.min(time, 2147483647));
                }
              }
            });
          }catch{}
        }
      }
      closeModal();
      render();
    });

    /* ---------------- Search + keyboard ---------------- */
    const debounce = (fn,ms=250)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
    qs('#searchInput').addEventListener('input', debounce(e=>{ search = e.target.value; render(); }, 150));

    document.addEventListener('keydown', (e)=>{
      if(e.key==='/' && document.activeElement.tagName!=='INPUT' && document.activeElement.tagName!=='TEXTAREA'){ e.preventDefault(); qs('#searchInput').focus(); }
      if(e.key.toLowerCase()==='n'){ openModal(); }
      if(e.key.toLowerCase()==='d'){ toggleDark(); }
      if(e.key==='Escape'){ closeModal(); }
    });

    /* ---------------- Import / Export ---------------- */
    function exportTasks(){
      const data = JSON.stringify(Store.all(), null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'taskflow_tasks.json'; a.click();
      URL.revokeObjectURL(url);
    }
    async function importTasks(file){
      if(!file) return;
      const text = await file.text();
      try{
        const arr = JSON.parse(text);
        if(!Array.isArray(arr)) throw new Error('Invalid file format');
        const now = new Date().toISOString();
        // normalize
        const normalized = arr.map(t => ({
          id: t.id || ('task_'+Date.now()+'_'+Math.random().toString(36).slice(2,8)),
          title: t.title || 'Untitled',
          description: t.description || '',
          priority: t.priority || 'medium',
          dueDate: t.dueDate || null,
          tags: Array.isArray(t.tags) ? t.tags : [],
          remind: !!t.remind,
          completed: !!t.completed,
          createdAt: t.createdAt || now,
          updatedAt: now,
        }));
        localStorage.setItem(key(), JSON.stringify(normalized.concat(Store.all())));
        render();
      }catch(e){
        alert('Could not import file: '+e.message);
      }
    }

    /* ---------------- Auth flows ---------------- */
    function swap(showId){
      // hide all shells
      ['authShell','signupShell','forgotShell','verifyShell','appShell'].forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        if(id===showId){ el.classList.remove('hidden'); el.classList.add('flex'); }
        else { el.classList.add('hidden'); el.classList.remove('flex'); }
      });
    }
    function showLogin(){ swap('authShell'); }
    function showSignup(){ swap('signupShell'); }
    function showForgot(){ swap('forgotShell'); }
    function showVerify(){ swap('verifyShell'); }
    function showApp(){ swap('appShell'); }

    function showError(id,msg){ const e=document.getElementById(id); e.textContent=msg; e.classList.remove('hidden'); }
    function showSuccess(id,msg){ const e=document.getElementById(id); e.textContent=msg; e.classList.remove('hidden'); }

    // Dark mode
    function applyDarkFlag(){ if(localStorage.getItem('darkMode')==='true') document.body.classList.add('dark'); }
    function toggleDark(){ document.body.classList.toggle('dark'); localStorage.setItem('darkMode', document.body.classList.contains('dark') ); }
    qs('#toggleDark').onclick = toggleDark;
    qs('#darkBtn').onclick = toggleDark;

    // Password helpers
    function checkPasswordStrength(){
      const pwd = qs('#signupPassword').value;
      const s = document.getElementById('passwordStrength');
      const score = [/[a-z]/,/[A-Z]/,/\d/,/[^a-zA-Z0-9]/].reduce((acc,r)=>acc + (r.test(pwd)?1:0),0) + (pwd.length>=8?1:0);
      s.textContent = score<=2 ? 'Weak' : score===3 ? 'Medium' : 'Strong';
      s.className = 'text-xs ' + (score<=2?'text-red-600':score===3?'text-yellow-600':'text-green-600');
    }
    document.getElementById('signupPassword').addEventListener('input', checkPasswordStrength);
    document.getElementById('confirmSignupPassword').addEventListener('input', ()=>{
      const m=document.getElementById('confirmPasswordMessage');
      m.textContent = (qs('#signupPassword').value===qs('#confirmSignupPassword').value) ? '✅ Passwords match' : '❌ Passwords do not match';
      m.className = 'text-xs ' + (m.textContent.startsWith('✅')?'text-green-600':'text-red-600');
    });

    // Login
    document.getElementById('loginForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const email = qs('#loginEmail').value.trim();
      const password = qs('#loginPassword').value;
      if(!email || !password){ showError('loginError','Please fill in all fields.'); return; }
      try{
        const { user } = await auth.signInWithEmailAndPassword(email,password);
        if(!user.emailVerified){ showError('loginError','Please verify your email first.'); await auth.signOut(); return; }
        currentUser = user;
        document.getElementById('userEmailBadge').textContent = user.email;
        showApp(); applyDarkFlag(); render(); initializeChatbot();
      }catch(err){ showError('loginError', err.message); }
    });

    // Signup
    document.getElementById('signupForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const name = qs('#signupName').value.trim();
      const email = qs('#signupEmail').value.trim();
      const password = qs('#signupPassword').value;
      const confirm = qs('#confirmSignupPassword').value;
      if(!name || !email || !password){ showError('signupError','Please fill in all fields.'); return; }
      if(password!==confirm){ showError('signupError','Passwords do not match.'); return; }
      try{
        const cred = await auth.createUserWithEmailAndPassword(email,password);
        await cred.user.updateProfile({ displayName: name });
        await cred.user.sendEmailVerification({ handleCodeInApp:false });
        document.getElementById('verificationEmail').textContent = email;
        showSuccess('signupSuccess','Account created! Check your inbox for a verification email.');
        setTimeout(showVerify, 800);
      }catch(err){ showError('signupError', err.message); }
    });

    // Forgot
    document.getElementById('forgotPasswordForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const email = qs('#forgotEmail').value.trim();
      if(!email){ showError('forgotError','Please enter your email.'); return; }
      try{ await auth.sendPasswordResetEmail(email); showSuccess('forgotSuccess','Reset email sent!'); }
      catch(err){ showError('forgotError', err.message); }
    });

    // Verify controls
    document.getElementById('resendBtn').onclick = async ()=>{
      if(!auth.currentUser){ showError('verificationError','Please sign in again.'); return; }
      try{ await auth.currentUser.sendEmailVerification({handleCodeInApp:false}); showSuccess('verificationSuccess','Verification email sent.'); }
      catch(err){ showError('verificationError', err.message); }
    };
    document.getElementById('checkVerificationBtn').onclick = async ()=>{
      if(!auth.currentUser){ showError('verificationError','Please sign in again.'); return; }
      await auth.currentUser.reload();
      if(auth.currentUser.emailVerified){
        currentUser = auth.currentUser;
        document.getElementById('userEmailBadge').textContent = currentUser.email;
        showSuccess('verificationSuccess','Email verified! Redirecting…');
        setTimeout(()=>{ showApp(); render(); initializeChatbot(); }, 800);
      }else{
        showError('verificationError','Email not yet verified.');
      }
    };

    // Global auth listener (refresh page etc.)
    auth.onAuthStateChanged(user=>{
      currentUser = user;
      if(!user){ showLogin(); }
    });

    // Logout
    async function logout(){ await auth.signOut(); showLogin(); }

    // Dark initial
    applyDarkFlag();

    // Modal interactions
    document.getElementById('modal').addEventListener('click', closeModal);

    // Chatbot hook (keep your implementation here)
    function initializeChatbot(){
      // You can mount your bot UI or 3rd-party widget here.
      // e.g., window.myBot?.mount()
    }

    // Focus shortcuts on page load for convenience
    window.addEventListener('load', ()=>{
      qs('#searchInput').placeholder += '  Press N for new task';
    });
  </script>
</body>
</html>
